<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blood Pressure Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  section { display:none; margin-top:20px; }
  table, th, td { border:1px solid black; border-collapse:collapse; padding:5px; }
</style>
</head>
<body>
<h2>Blood Pressure Tracker</h2>

<nav>
  <button onclick="showTab('loginSection')">Login</button>
  <button onclick="showTab('registerSection')">Register</button>
  <button onclick="logout()">Logout</button>
  <button onclick="showTab('trackerSection')">Tracker</button>
  <button onclick="showTab('adminSection')">Admin</button>
  <button onclick="showTab('publicSection')">Public</button>
</nav>

<section id="loginSection">
  <h3>Login</h3>
  <form id="loginForm">
    <input id="loginUser" placeholder="Username" required>
    <input type="password" id="loginPass" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>
</section>

<section id="registerSection">
  <h3>Register</h3>
  <form id="registerForm">
    <input id="regUser" placeholder="Username" required>
    <input type="password" id="regPass" placeholder="Password" required>
    <button type="submit">Register</button>
  </form>
</section>

<section id="trackerSection">
  <h3>Record BP</h3>
  <form id="bpForm">
    <input type="number" id="systolic" placeholder="Systolic" required>
    <input type="number" id="diastolic" placeholder="Diastolic" required>
    <button type="submit">Save</button>
  </form>
  <table id="bpTable"><tr><th>Date</th><th>Systolic</th><th>Diastolic</th><th>Action</th></tr></table>
  <canvas id="bpChart" width="400" height="200"></canvas>
</section>

<section id="adminSection">
  <h3>Admin Panel</h3>
  <table id="adminTable"><tr><th>User</th><th>Status</th><th>Action</th></tr></table>
</section>

<section id="publicSection">
  <h3>Public Records</h3>
  <select id="userSelect"></select>
  <table id="publicTable"><tr><th>Date</th><th>Systolic</th><th>Diastolic</th></tr></table>
</section>

<script>
window.onload = function() {
  let users = JSON.parse(localStorage.getItem("users") || "[]");
  let records = JSON.parse(localStorage.getItem("records") || "{}");
  let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
  let chart;

  function saveData() {
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("records", JSON.stringify(records));
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  }

  // Navigation
  window.showTab = function(id) {
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";
    if(id==="trackerSection") renderTable();
    if(id==="adminSection") renderAdmin();
    if(id==="publicSection") renderPublic();
  };

  window.logout = function(){
    currentUser = null;
    saveData();
    showTab("loginSection");
  };

  // Register
  document.getElementById("registerForm").onsubmit = e=>{
    e.preventDefault();
    let u=document.getElementById("regUser").value;
    let p=document.getElementById("regPass").value;
    if(users.find(x=>x.username===u)) return alert("User exists");
    users.push({username:u,password:p,blocked:false});
    records[u]=[];
    saveData();
    alert("Registered!");
  };

  // Login
  document.getElementById("loginForm").onsubmit = e=>{
    e.preventDefault();
    let u=document.getElementById("loginUser").value;
    let p=document.getElementById("loginPass").value;
    let user=users.find(x=>x.username===u && x.password===p);
    if(!user) return alert("Invalid");
    if(user.blocked) return alert("Blocked");
    currentUser=user.username;
    saveData();
    showTab("trackerSection");
  };

  // Record BP
  document.getElementById("bpForm").onsubmit = e=>{
    e.preventDefault();
    if(!currentUser) return alert("Login first");
    let s=+document.getElementById("systolic").value;
    let d=+document.getElementById("diastolic").value;
    let rec={date:new Date().toLocaleString(),systolic:s,diastolic:d};
    records[currentUser].push(rec);
    saveData();
    renderTable();
  };

  function renderTable(){
    let t=document.getElementById("bpTable");
    t.innerHTML="<tr><th>Date</th><th>Systolic</th><th>Diastolic</th><th>Action</th></tr>";
    (records[currentUser]||[]).forEach((r,i)=>{
      t.innerHTML+=`<tr><td>${r.date}</td><td>${r.systolic}</td><td>${r.diastolic}</td>
      <td><button onclick="deleteBP(${i})">Delete</button></td></tr>`;
    });
    renderChart();
  }

  function renderChart(){
    let ctx=document.getElementById("bpChart");
    let data=records[currentUser]||[];
    let labels=data.map(r=>r.date);
    let sys=data.map(r=>r.systolic);
    let dia=data.map(r=>r.diastolic);
    if(chart) chart.destroy();
    chart=new Chart(ctx,{type:"line",
      data:{labels,datasets:[
        {label:"Systolic",data:sys,borderColor:"red"},
        {label:"Diastolic",data:dia,borderColor:"blue"}
      ]}});
  }

  window.deleteBP=function(i){
    records[currentUser].splice(i,1);
    saveData();
    renderTable();
  };

  function renderAdmin(){
    let t=document.getElementById("adminTable");
    t.innerHTML="<tr><th>User</th><th>Status</th><th>Action</th></tr>";
    users.forEach(u=>{
      t.innerHTML+=`<tr><td>${u.username}</td><td>${u.blocked?"Blocked":"Active"}</td>
      <td><button onclick="toggleBlock('${u.username}')">${u.blocked?"Unblock":"Block"}</button>
      <button onclick="revokeUser('${u.username}')">Revoke</button></td></tr>`;
    });
  }

  window.toggleBlock=function(user){
    let u=users.find(x=>x.username===user);
    u.blocked=!u.blocked;
    saveData(); renderAdmin();
  };

  window.revokeUser=function(user){
    users=users.filter(x=>x.username!==user);
    delete records[user];
    saveData(); renderAdmin();
  };

  function renderPublic(){
    let select=document.getElementById("userSelect");
    select.innerHTML="";
    users.forEach(u=>select.innerHTML+=`<option value="${u.username}">${u.username}</option>`);
    select.onchange=()=>{
      let uname=select.value;
      let t=document.getElementById("publicTable");
      t.innerHTML="<tr><th>Date</th><th>Systolic</th><th>Diastolic</th></tr>";
      (records[uname]||[]).forEach(r=>{
        t.innerHTML+=`<tr><td>${r.date}</td><td>${r.systolic}</td><td>${r.diastolic}</td></tr>`;
      });
    };
    select.onchange();
  }

  // Show login/register if no one logged in
  if (!currentUser) {
    document.getElementById("loginSection").style.display = "block";
    document.getElementById("registerSection").style.display = "block";
  } else {
    showTab("trackerSection");
  }
};
</script>
</body>
</html>
